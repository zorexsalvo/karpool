{% extends 'base.html' %}

{% block title %}{{ event.name }} - Carpool{% endblock %}

{% block content %}
<h1>{{ event.name }}</h1>

{% if event.date or event.location %}
<div style="margin-bottom: 20px; color: #666;">
    {% if event.date %}Date: {{ event.date|date:"M d, Y" }}{% endif %}
    {% if event.date and event.location %} • {% endif %}
    {% if event.location %}{{ event.location }}{% endif %}
</div>
{% endif %}

<div class="url-copy">
    <input type="text" value="{{ request.build_absolute_uri }}" readonly id="event-url">
    <button type="button" onclick="copyUrl()" class="btn">Copy Link</button>
</div>

<!-- Add Car Form -->
<div class="card">
    <h3>Add Car</h3>
    <form method="post" action="{% url 'add_car' event.slug %}">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: 1fr 1fr 80px; gap: 10px; margin-bottom: 10px;">
            <input type="text" name="driver_name" placeholder="Driver name" required>
            <input type="text" name="car_name" placeholder="Car name (optional)">
            <input type="number" name="capacity" placeholder="Seats" min="1">
        </div>
        <textarea name="notes" placeholder="Notes (optional)" rows="2"></textarea>
        <button type="submit" class="btn btn-primary">Add Car</button>
    </form>
</div>

<!-- Add Member Form -->
<div class="card">
    <h3>Join Event</h3>
    <form method="post" action="{% url 'add_member' event.slug %}">
        {% csrf_token %}
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <input type="text" name="name" placeholder="Your name" required>
            <input type="text" name="contact" placeholder="Contact (optional)">
            <select name="car">
                <option value="">No car yet</option>
                {% for car in cars %}
                    <option value="{{ car.id }}">{{ car.driver_name }}{% if car.car_name %} ({{ car.car_name }}){% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Join</button>
    </form>
</div>

<!-- Cars -->
{% for car in cars %}
<div class="card">
    <div class="car-header">
        <div>
            <strong>{{ car.driver_name }}</strong>
            {% if car.car_name %}<em>{{ car.car_name }}</em>{% endif %}
            {% if car.capacity %}
                <span style="color: #666;">
                    ({{ car.members.count }}/{{ car.capacity }} 
                    {% if car.available_spots > 0 %}
                        • {{ car.available_spots }} available)
                    {% else %}
                        • full)
                    {% endif %}
                </span>
            {% endif %}
        </div>
        <form method="post" action="{% url 'delete_car' event.slug car.id %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-small" 
                    onclick="return confirm('Delete car?')">×</button>
        </form>
    </div>
    
    {% if car.notes %}
        <div style="margin-bottom: 15px; color: #666;">{{ car.notes }}</div>
    {% endif %}
    
    <div class="members">
        {% for member in car.members.all %}
            <div class="member">
                <div>
                    <strong>{{ member.name }}</strong>
                    {% if member.contact %}<br><small>{{ member.contact }}</small>{% endif %}
                </div>
                <div class="actions">
                    <button onclick="showMoveModal({{ member.id }}, '{{ member.name }}')" 
                            class="btn btn-small">Move</button>
                    <form method="post" action="{% url 'delete_member' event.slug member.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-small" 
                                onclick="return confirm('Remove {{ member.name }}?')">×</button>
                    </form>
                </div>
            </div>
        {% empty %}
            <div style="color: #666; font-style: italic;">No members in this car yet</div>
        {% endfor %}
    </div>
</div>
{% empty %}
<div class="card">
    <div style="text-align: center; color: #666;">No cars added yet</div>
</div>
{% endfor %}

<!-- Unassigned Members -->
{% if unassigned_members %}
<div class="card">
    <h3>Unassigned Members</h3>
    <div class="members">
        {% for member in unassigned_members %}
            <div class="member">
                <div>
                    <strong>{{ member.name }}</strong>
                    {% if member.contact %}<br><small>{{ member.contact }}</small>{% endif %}
                </div>
                <div class="actions">
                    <button onclick="showMoveModal({{ member.id }}, '{{ member.name }}')" 
                            class="btn btn-small">Assign</button>
                    <form method="post" action="{% url 'delete_member' event.slug member.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-small" 
                                onclick="return confirm('Remove {{ member.name }}?')">×</button>
                    </form>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Move Member Modal -->
<div id="moveModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Move Member</h3>
        <form method="post" id="moveForm">
            {% csrf_token %}
            <div class="form-group">
                <label>Assign to:</label>
                <select name="car" id="carSelect">
                    <option value="">Unassigned</option>
                    {% for car in cars %}
                        <option value="{{ car.id }}">{{ car.driver_name }}{% if car.car_name %} ({{ car.car_name }}){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" onclick="hideMoveModal()" class="btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function copyUrl() {
    const input = document.getElementById('event-url');
    input.select();
    document.execCommand('copy');
    
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    setTimeout(() => {
        button.textContent = originalText;
    }, 1000);
}

function showMoveModal(memberId, memberName) {
    document.getElementById('modalTitle').textContent = 'Move ' + memberName;
    document.getElementById('moveForm').action = `/event/{{ event.slug }}/member/${memberId}/update/`;
    document.getElementById('moveModal').classList.add('show');
}

function hideMoveModal() {
    document.getElementById('moveModal').classList.remove('show');
}

// Close modal when clicking outside
document.getElementById('moveModal').onclick = function(e) {
    if (e.target === this) {
        hideMoveModal();
    }
}
</script>
{% endblock %}